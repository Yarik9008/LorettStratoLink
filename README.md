# LorettLink

Передача изображений со стратосферного зонда по радиоканалу LoRa/FSK с erasure-FEC (Reed–Solomon).

## Состав


| Часть            | Описание                                                     |
| ---------------- | ------------------------------------------------------------ |
| `LorettLink_tx/` | Прошивка бортового передатчика (PlatformIO, STM32)           |
| `LorettLink_rx/` | Прошивка наземного приёмника (PlatformIO, STM32)             |
| `receiver/`      | Наземная станция — приём, декодирование, GUI (Python, PyQt5) |
| `transmitter/`   | Симулятор передатчика для тестов (Python)                    |


## Запуск

**Приёмник (ПК):**

```bash
cd receiver && python lorettlink_receiver.py
```

**Симулятор передатчика:**

```bash
cd transmitter && python lorettlink_transmitter.py
```

**Прошивки:** сборка и загрузка через PlatformIO в каталогах прошивок (см. ниже).

---

## Протокол связи

Связь **однонаправленная**: борт только передаёт, обратного канала нет. В потоке от приёмника к ПК идут два типа пакетов: **FEC** (блоки файла) и **TELEM** (телеметрия).

### FEC-пакет (256 байт)


| Смещение | Размер | Поле        | Описание                                                 |
| -------- | ------ | ----------- | -------------------------------------------------------- |
| 0        | 1      | sync        | 0x55                                                     |
| 1        | 1      | type        | 0x68 (FEC)                                               |
| 2..5     | 4      | callsign    | Base-40, big-endian (до 6 символов)                      |
| 6        | 1      | image_id    | Номер изображения в цикле                                |
| 7..8     | 2      | block_id    | Номер блока (0..K−1 данные, K..N−1 — parity), big-endian |
| 9..10    | 2      | k_data      | Число блоков данных K, big-endian                        |
| 11..12   | 2      | n_total     | Всего блоков N = K + parity, big-endian                  |
| 13..16   | 4      | file_size   | Размер файла в байтах, big-endian                        |
| 17       | 1      | file_type   | 0x00 raw, 0x01 JPEG, 0x02 WebP                           |
| 18       | 1      | m_per_group | Parity-блоков на одну RS-группу                          |
| 19       | 1      | num_groups  | Число RS-групп                                           |
| 20..219  | 200    | payload     | Полезные данные блока                                    |
| 220..223 | 4      | crc32       | CRC-32 байт [1..219] (zlib-совместимый)                  |
| 224..255 | 32     | reserved    | Зарезервировано (нули)                                   |


### Erasure-FEC (Reed–Solomon)

- Файл разбивается на **K** блоков по **200 байт** (последний блок дополняется нулями).
- Код RS в поле **GF(2⁸)** (максимум 255 символов на группу). Данные разбиваются на **num_groups** групп; в каждой группе **g_size** блоков данных и **m_per_group** блоков чётности. Итого передаётся **N** = K + num_groups × m_per_group пакетов.
- Коэффициент избыточности задаётся отношением (по умолчанию ~25%): добавляется примерно четверть parity-блоков от K.
- **Восстановление:** при потере части пакетов достаточно любых **K** из **N** (erasure: номера потерянных блоков известны). Декодер по группам восстанавливает недостающие блоки по столбцам (200 столбцов по 1 байту).

### TELEM-пакет (10 байт)


| Смещение | Размер | Поле      | Описание                          |
| -------- | ------ | --------- | --------------------------------- |
| 0..1     | 2      | sync      | 0xA55A (little-endian: 0x5A 0xA5) |
| 2        | 1      | proto_ver | 0x01                              |
| 3        | 1      | type      | 0x30 (TELEM)                      |
| 4..5     | 2      | rssi      | RSSI (int16, LE)                  |
| 6        | 1      | snr       | SNR (int8)                        |
| 7        | 1      | tx_power  | Мощность передатчика              |
| 8..9     | 2      | crc16     | CRC-16 CCITT от байт [2..7]       |


Приёмник (STM32) после каждого принятого FEC-пакета от E22 отправляет на ПК сначала 256 байт FEC, затем 10 байт TELEM с текущим RSSI.

### Радио

Модуль E22 (LoRa/FSK) в **прозрачном режиме**: пакет 256 байт уходит в эфир как есть. На приёме E22 может добавлять байт RSSI после каждого кадра (тогда из UART приходит 257 байт на один FEC-пакет).

---

## Прошивки

Обе прошивки собираются в **PlatformIO** (framework **STM32Cube**), плата — **STM32F412RG**. Загрузка по **ST-Link**.

### Передатчик (`LorettLink_tx/`)

**Назначение:** бортовая часть. Читает JPEG с microSD, кодирует поток в FEC-пакеты (Reed–Solomon erasure), отправляет в эфир через радиомодуль E22 (LoRa/FSK).

- **Железо:** STM32F412, SDIO → microSD, UART1 → E22 (M0/M1/AUX), UART2 — отладочный вывод.
- **Модули:** `e22_driver` (радио), `sd_fatfs` (FatFS, поиск и чтение JPEG), `gf256`/`rs_encode` (Reed–Solomon), `fec_packet` (формат пакета 256 байт: заголовок, блок 200 байт, CRC32).
- **Цикл:** перебор файлов на SD → чтение в буфер (до 64 КБ) → разбиение на блоки, расчёт parity по группам → отправка K данных + parity-блоки в эфир с паузой между пакетами.

### Приёмник (`LorettLink_rx/`)

**Назначение:** наземный радиомост. Принимает от E22 FEC-пакеты и телеметрию, пересылает их на ПК по UART (USB-UART мост).

- **Железо:** STM32F412, UART1 → E22 (приём), UART2 → ПК (115200).
- **Модули:** `e22_driver` (радио в режиме RX), `telem` — сборка телеметрических пакетов (RSSI и др.) для наземной программы.
- **Логика:** прерывание по приёму UART → кольцевой буфер, поиск синхрослова FEC (0x55 0x68) → выдача 256-байтного FEC-пакета на ПК, следом TELEM-пакет с RSSI. Декодирование FEC и сборка файлов выполняет ПК (receiver).

---

## SD-карта и изображения (передатчик)

**Какие карты подходят:**

- microSD или SD (через переходник). Объём — на усмотрение (обычно 4–32 ГБ).
- Файловая система — **FAT32** (карту отформатировать в FAT32).
- Лучше использовать карты известных производителей (SanDisk, Samsung, Kingston и т.п.); проблемные или очень старые карты могут не инициализироваться по SDIO.

**Как хранить изображения:**

- Файлы **только в корне** карты (не в подпапках).
- Формат — **JPEG**, расширение имени файла — **.jpg** или **.JPG** (регистр не важен).
- Имена файлов — в формате **8.3** (например, `IMG001.jpg`, `SHOT.JPG`).
- Размер одного файла — **не более 64 КБ** (65 536 байт). Файлы больше этого размера прошивка пропускает.
- Порядок передачи — по порядку перебора каталога (зависит от файловой системы).

